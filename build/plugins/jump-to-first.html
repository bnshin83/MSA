<!-- jump to first plugin -->

<script>
    ///////////////////////////
    // DESCRIPTION
    ///////////////////////////

    // This Manubot plugin adds a button next to each citation, figure, and table that jumps the page to the first instance of that reference in the document.

    (function() {
        ///////////////////////////
        // ASSETS
        ///////////////////////////

        // html svg of arrow icon
        let arrowIcon =
            "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 320 512'><path fill='currentColor' d='M177 255.7l136 136c9.4 9.4 9.4 24.6 0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9 0L160 351.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9 0L7 425.7c-9.4-9.4-9.4-24.6 0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1zm-34-192L7 199.7c-9.4 9.4-9.4 24.6 0 33.9l22.6 22.6c9.4 9.4 24.6 9.4 33.9 0l96.4-96.4 96.4 96.4c9.4 9.4 24.6 9.4 33.9 0l22.6-22.6c9.4-9.4 9.4-24.6 0-33.9l-136-136c-9.2-9.4-24.4-9.4-33.8 0z'></path></svg>";

        ///////////////////////////
        // SCRIPT
        ///////////////////////////

        // start script
        function start() {
            makeCitationButtons();
            makeFigureButtons();
            makeTableButtons();
        }

        // get first occurence of ref in document
        function getFirstRef(id) {
            return document.querySelector("a[href='#" + id + "']");
        }

        // when jump button clicked
        function onButtonClick() {
            let target = getFirstRef(this.dataset.refId);
            if (!target) return;

            // expand section if collapsed, scroll to target, remove any
            expandElement(target);
            let y =
                target.getBoundingClientRect().top -
                document.body.getBoundingClientRect().top -
                window.innerHeight * 0.5;
            window.scrollTo(0, y);
            window.dispatchEvent(new Event("scroll")); // trigger any function listening for "onscroll" event
            target.focus();
        }

        // add button next to each citation
        function makeCitationButtons() {
            let citations = document.querySelectorAll("div[id^='ref-']");
            for (let citation of citations) {
                // get ref id and container element to add button to
                let id = citation.id;
                let container = citation.firstElementChild;
                let firstRef = getFirstRef(id);

                // if can't find reference, ignore
                if (!firstRef) continue;

                // make jump button
                let button = document.createElement("button");
                button.className = "icon_button jump_arrow";
                button.innerHTML = arrowIcon;
                button.dataset.refId = id;
                button.dataset.tooltipIgnore = "true"; // ** for use with tooltip plugin
                container.innerHTML = button.outerHTML + container.innerHTML;
                button = container.firstElementChild;
                button.addEventListener("click", onButtonClick);
            }
        }

        // add button next to each figure
        function makeFigureButtons() {
            let figures = document.querySelectorAll("img[id^='fig:']");
            for (let figure of figures) {
                // get ref id and container element to add button to
                let id = figure.id;
                let container = figure.nextElementSibling;
                let firstRef = getFirstRef(id);

                // if can't find reference, ignore
                if (!firstRef) continue;

                // make jump button
                let button = document.createElement("button");
                button.className = "icon_button jump_arrow";
                button.innerHTML = arrowIcon;
                button.dataset.refId = id;
                button.dataset.tooltipIgnore = "true"; // ** for use with tooltip plugin
                container.insertBefore(button, container.firstElementChild);
                button.addEventListener("click", onButtonClick);
            }
        }

        // add button next to each figure
        function makeTableButtons() {
            let tables = document.querySelectorAll("a[name^='tbl:']");
            for (let table of tables) {
                // get ref id and container element to add button to
                let id = table.name;
                let container = table.nextElementSibling.querySelector("caption");
                let firstRef = getFirstRef(id);

                // if can't find reference, ignore
                if (!firstRef) continue;

                // make jump button
                let button = document.createElement("button");
                button.className = "icon_button jump_arrow";
                button.innerHTML = arrowIcon;
                button.dataset.refId = id;
                button.dataset.tooltipIgnore = "true"; // ** for use with tooltip plugin
                container.insertBefore(button, container.firstElementChild);
                button.addEventListener("click", onButtonClick);
            }
        }

        // ** for use with accordion plugin
        // get closest element before specified element that matches query
        function firstBefore(element, query) {
            while (
                ((element = element.previousElementSibling || element.parentNode),
                element && element !== document.body)
            )
                if (element.matches(query)) return element;
        }

        // ** for use with accordion plugin
        // check if element is part of collapsed heading
        function isCollapsed(element) {
            while (element && element !== document.body) {
                if (element.dataset.collapsed === "true") return true;
                element = element.parentNode;
            }
            return false;
        }

        // ** for use with accordion plugin
        // expand heading containing element if necesary
        function expandElement(element) {
            if (isCollapsed(element)) {
                let heading = firstBefore(element, "h2");
                if (heading) heading.click();
            }
        }

        // start script when document is finished loading
        window.addEventListener("load", start);
    })();
</script>
