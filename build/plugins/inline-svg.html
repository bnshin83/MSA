<!-- inline svg plugin -->

<script>
  (function() {
      // /////////////////////////
      // DESCRIPTION
      // /////////////////////////

      // This Manubot plugin fetches the text source code of SVGs in <img> tags,
      // and inserts it into the document in place. This provides many
      // advantages, such as being able to style SVGs globally from the CSS
      // themes, and being able to make SVGs interactive with JavaScript and D3.

      // /////////////////////////
      // SCRIPT
      // /////////////////////////

      // start script
      async function start() {
          // get all <img> tags that have "src" attributes that end with ".svg"
          const imgs = document.querySelectorAll('img[src$=".svg"]');
          const inlineSvgs = Array.from(imgs).map(inlineSvg);
          await Promise.all(inlineSvgs);

          // dispatch "inline finished" event
          // user d3 scripts should wait to hear this event before running
          document.dispatchEvent(new Event('D3Loaded'));
      }

      // take an svg <img> tag, fetch its source code, and replace it 
      async function inlineSvg(img) {
          try {
              // fetch svg source code
              const response = await fetch(img.src);
              if (!response.ok) throw new Error('No SVG source')
              const source = await response.text();
              if (!source.trim()) throw new Error('No SVG source');
              // parse specifically as svg, create new (hidden) dom node
              const svg = new DOMParser()
                  .parseFromString(source, 'image/svg+xml')
                  .querySelector('svg');
              if (!svg) throw new Error('Couldn\'t parse SVG');
              // transfer original img attributes into new svg
              for (const { name, value } of img.attributes)
                  svg.setAttribute(name, value);
              // replace original image with new svg
              img.outerHTML = svg.outerHTML;
          } catch (error) {
              console.log(error);
          }
      }

      // start script when document is finished loading
      window.addEventListener('load', start);
  })();
</script>
